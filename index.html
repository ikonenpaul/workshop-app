// --- KONFIGURATION ---
const SUPABASE_URL = 'https://bntzsbeglcnewcqhmsva.supabase.co/'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJudHpzYmVnbGNuZXdjcWhtc3ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4Mzg1MzAsImV4cCI6MjA4NzQxNDUzMH0.p76BhO6IWuPCTzDyHO6OXU6UXUGBH352nFhrHcVinsU';
const TARGET_STUDENT_COUNT = 1; // Zum Testen auf 1, für Workshop auf 20/25 stellen

// Initialisierung der Datenbank-Verbindung
// Wir nennen die Variable 'db', um Konflikte mit dem Namen der Bibliothek 'supabase' zu vermeiden
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const topics = [
    { id: 1, name: "Taschengeld, Geld & Management" },
    { id: 2, name: "Freizeitgestaltung & soz. Teilhabe" },
    { id: 3, name: "Digitalisierung & Mediennutzung" },
    { id: 4, name: "Gesundheit & Stress im Alltag" },
    { id: 5, name: "Soziale Gerechtigkeit & Ungleichheit" }
];

const questions = [
    { t: 1, q: "Ich möchte lernen, wie man einen Finanzplan erstellt." },
    { t: 1, q: "Es ist wichtig zu wissen, wie Banken funktionieren." },
    { t: 1, q: "Schüler sollten mehr über Steuern lernen." },
    { t: 1, q: "Ich überlege genau, wofür ich mein Geld ausgebe." },
    { t: 1, q: "Geld sparen für große Ziele fällt mir leicht." },
    { t: 2, q: "Jeder Jugendliche sollte kostenlose Sportangebote haben." },
    { t: 2, q: "Ich wünsche mir mehr Treffpunkte für Jugendliche." },
    { t: 2, q: "Hobbys sollten nicht vom Geld der Eltern abhängen." },
    { t: 2, q: "Vereine sollten für alle Menschen bezahlbar sein." },
    { t: 2, q: "Ich verbringe meine Freizeit gerne aktiv in der Gemeinschaft." },
    { t: 3, q: "Ich will verstehen, wie Algorithmen Social Media steuern." },
    { t: 3, q: "Datenschutz im Internet beschäftigt mich." },
    { t: 3, q: "KI wird meinen zukünftigen Job stark verändern." },
    { t: 3, q: "Digitale Geräte sollten im Unterricht mehr genutzt werden." },
    { t: 3, q: "Ich hinterfrage kritisch, was ich im Internet lese." },
    { t: 4, q: "Der Leistungsdruck in der Schule belastet mich oft." },
    { t: 4, q: "Ich möchte lernen, in Stresssituationen ruhig zu bleiben." },
    { t: 4, q: "Gesunde Ernährung sollte in der Schule wichtiger sein." },
    { t: 4, q: "Ausreichend Schlaf und Erholung sind mir wichtig." },
    { t: 4, q: "Ich merke körperlich, wenn ich zu viel Stress habe." },
    { t: 5, q: "Die Schere zwischen Arm und Reich ist zu groß." },
    { t: 5, q: "Herkunft darf keinen Einfluss auf Bildungschancen haben." },
    { t: 5, q: "Ich finde es wichtig, sich gegen Diskriminierung einzusetzen." },
    { t: 5, q: "Reichtum sollte in einer Gesellschaft fairer verteilt werden." },
    { t: 5, q: "Ich interessiere mich für politische Entscheidungen." }
];

let currentStudentName = "";
let appStep = 0; 
let studentScores = { 1:0, 2:0, 3:0, 4:0, 5:0 };

// Diese Funktion startet die App
function startApp() {
    console.log("Start-Button geklickt"); // Test-Log für die Konsole
    const nameInput = document.getElementById('studentName');
    currentStudentName = nameInput.value.trim();

    if(!currentStudentName) {
        alert("Bitte gib deinen Namen ein.");
        return;
    }

    // Umschalten der Ansicht
    document.getElementById('view-login').classList.add('hidden');
    document.getElementById('view-app').classList.remove('hidden');
    
    renderStep0();
}

function renderStep0() {
    const container = document.getElementById('questionContainer');
    container.innerHTML = "<h3>Wie wichtig sind dir diese Themen allgemein?</h3>";
    topics.forEach(t => {
        container.innerHTML += createRatingHTML(`topic_${t.id}`, t.name, t.id);
    });
    updateProgressBar(20);
}

function renderStep1() {
    const container = document.getElementById('questionContainer');
    container.innerHTML = "<h3>Beantworte bitte folgende Aussagen:</h3>";
    const shuffled = [...questions].sort(() => Math.random() - 0.5);
    shuffled.forEach((q, i) => {
        container.innerHTML += createRatingHTML(`q_${i}`, q.q, q.t);
    });
    document.getElementById('nextBtn').innerText = "Absenden & Auswerten";
    updateProgressBar(100);
    window.scrollTo(0,0);
}

function createRatingHTML(name, label, topicId) {
    return `
        <div class="question-block">
            <label>${label}</label>
            <div class="options">
                ${[1,2,3,4,5].map(n => `
                    <div class="option">
                        <input type="radio" name="${name}" data-topic="${topicId}" value="${n}" required>
                        <br>${n}
                    </div>`).join('')}
            </div>
            <div style="display:flex; justify-content:space-between; font-size:0.7em; max-width:400px; color:#666; margin-top:5px;">
                <span>unwichtig</span><span>sehr wichtig</span>
            </div>
        </div>`;
}

async function processStep() {
    const checked = document.querySelectorAll('#questionContainer input[type="radio"]:checked');
    const totalNeeded = (appStep === 0) ? topics.length : questions.length;
    
    if(checked.length < totalNeeded) {
        alert("Bitte alle Fragen beantworten.");
        return;
    }

    checked.forEach(input => {
        const tId = input.getAttribute('data-topic');
        studentScores[tId] = (studentScores[tId] || 0) + parseInt(input.value);
    });

    if(appStep === 0) {
        appStep = 1;
        renderStep1();
    } else {
        await submitData();
    }
}

async function submitData() {
    document.getElementById('view-app').classList.add('hidden');
    document.getElementById('view-waiting').classList.remove('hidden');

    const { error } = await db.from('submissions').insert([
        { name: currentStudentName, scores: studentScores }
    ]);

    if(error) {
        console.error("Fehler beim Speichern:", error);
        alert("Fehler beim Speichern: " + error.message);
        return;
    }
    startPolling();
}

function startPolling() {
    const timer = setInterval(async () => {
        const { data } = await db.from('submissions').select('*');
        if(!data) return;

        document.getElementById('countDisplay').innerText = `${data.length} von ${TARGET_STUDENT_COUNT} Schülern sind bereit.`;

        if(data.length >= TARGET_STUDENT_COUNT) {
            // Erstzuweisung prüfen
            if(!data[0].assigned_group) {
                await calculateAssignments(data);
            }

            const me = data.find(s => s.name === currentStudentName);
            if(me && me.assigned_group) {
                clearInterval(timer);
                document.getElementById('view-waiting').classList.add('hidden');
                document.getElementById('view-result').classList.remove('hidden');
                document.getElementById('groupName').innerText = me.assigned_group;
            }
        }
    }, 3000);
}

async function calculateAssignments(allStudents) {
    const maxPerGroup = Math.ceil(allStudents.length / 5);
    
    allStudents.forEach(s => {
        s.pref = Object.entries(s.scores)
            .sort((a,b) => b[1] - a[1])
            .map(e => parseInt(e[0]));
        s.currentGroup = s.pref[0];
    });

    let changed = true;
    let iterations = 0;
    while(changed && iterations < 50) {
        changed = false;
        iterations++;
        for(let gId = 1; gId <= 5; gId++) {
            let members = allStudents.filter(s => s.currentGroup === gId);
            if(members.length > maxPerGroup) {
                let bestCandidate = null;
                let minLoss = Infinity;
                let targetG = null;

                members.forEach(s => {
                    for(let p=1; p < s.pref.length; p++) {
                        let nextG = s.pref[p];
                        if(allStudents.filter(st => st.currentGroup === nextG).length < maxPerGroup) {
                            let loss = s.scores[gId] - s.scores[nextG];
                            if(loss < minLoss) {
                                minLoss = loss;
                                bestCandidate = s;
                                targetG = nextG;
                            }
                            break;
                        }
                    }
                });

                if(bestCandidate) {
                    bestCandidate.currentGroup = targetG;
                    changed = true;
                }
            }
        }
    }

    for(let s of allStudents) {
        const topicName = topics.find(t => t.id === s.currentGroup).name;
        await db.from('submissions').update({ assigned_group: topicName }).eq('name', s.name);
    }
}

function updateProgressBar(p) { 
    const bar = document.getElementById('progressBar');
    if(bar) bar.style.width = p + "%"; 
}
